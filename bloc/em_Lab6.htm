<html>

<head>

<meta http-equiv=Content-Type content="text/html; charset=gb2312">
<meta name=Generator content="Microsoft Word 15 (filtered)">
<style>
<!--
 /* Font Definitions */
 @font-face
	{font-family:Wingdings;
	panose-1:5 0 0 0 0 0 0 0 0 0;}
@font-face
	{font-family:宋体;
	panose-1:2 1 6 0 3 1 1 1 1 1;}
@font-face
	{font-family:"Cambria Math";
	panose-1:2 4 5 3 5 4 6 3 2 4;}
@font-face
	{font-family:Calibri;
	panose-1:2 15 5 2 2 2 4 3 2 4;}
@font-face
	{font-family:Simsun;
	panose-1:0 0 0 0 0 0 0 0 0 0;}
@font-face
	{font-family:"\@宋体";
	panose-1:2 1 6 0 3 1 1 1 1 1;}
 /* Style Definitions */
 p.MsoNormal, li.MsoNormal, div.MsoNormal
	{margin:0cm;
	margin-bottom:.0001pt;
	text-align:justify;
	text-justify:inter-ideograph;
	font-size:10.5pt;
	font-family:"Calibri",sans-serif;}
h1
	{mso-style-link:"标题 1 Char";
	margin-top:17.0pt;
	margin-right:0cm;
	margin-bottom:16.5pt;
	margin-left:0cm;
	text-align:justify;
	text-justify:inter-ideograph;
	line-height:240%;
	page-break-after:avoid;
	font-size:22.0pt;
	font-family:"Calibri",sans-serif;
	font-weight:bold;}
h2
	{mso-style-link:"标题 2 Char";
	margin-right:0cm;
	margin-left:0cm;
	font-size:18.0pt;
	font-family:宋体;
	font-weight:bold;}
h3
	{mso-style-link:"标题 3 Char";
	margin-top:13.0pt;
	margin-right:0cm;
	margin-bottom:13.0pt;
	margin-left:0cm;
	text-align:justify;
	text-justify:inter-ideograph;
	line-height:173%;
	page-break-after:avoid;
	font-size:16.0pt;
	font-family:"Calibri",sans-serif;
	font-weight:bold;}
p
	{margin-right:0cm;
	margin-left:0cm;
	font-size:12.0pt;
	font-family:宋体;}
p.MsoListParagraph, li.MsoListParagraph, div.MsoListParagraph
	{margin:0cm;
	margin-bottom:.0001pt;
	text-align:justify;
	text-justify:inter-ideograph;
	text-indent:21.0pt;
	font-size:10.5pt;
	font-family:"Calibri",sans-serif;}
span.2Char
	{mso-style-name:"标题 2 Char";
	mso-style-link:"标题 2";
	font-family:宋体;
	font-weight:bold;}
span.1Char
	{mso-style-name:"标题 1 Char";
	mso-style-link:"标题 1";
	font-weight:bold;}
span.3Char
	{mso-style-name:"标题 3 Char";
	mso-style-link:"标题 3";
	font-weight:bold;}
.MsoChpDefault
	{font-family:"Calibri",sans-serif;}
 /* Page Definitions */
 @page WordSection1
	{size:595.3pt 841.9pt;
	margin:72.0pt 90.0pt 72.0pt 90.0pt;
	layout-grid:15.6pt;}
div.WordSection1
	{page:WordSection1;}
 /* List Definitions */
 ol
	{margin-bottom:0cm;}
ul
	{margin-bottom:0cm;}
-->
</style>

</head>

<body lang=ZH-CN style='text-justify-trim:punctuation'>

<div class=WordSection1 style='layout-grid:15.6pt'>

<p class=MsoNormal align=center style='text-align:center'><b><span lang=EN-US
style='font-size:18.0pt;font-family:"Simsun",serif;color:black'>Lab 6</span></b><b><span
style='font-size:18.0pt;font-family:宋体;color:black'>：</span></b><b><span
lang=EN-US style='font-size:18.0pt;font-family:"Simsun",serif;color:black'>Linux</span></b><b><span
style='font-size:18.0pt;font-family:宋体;color:black'>系统调用</span></b></p>

<p class=MsoNormal align=right style='text-align:right'><span lang=EN-US>3130102113
</span><span style='font-family:宋体'>钱立辉</span></p>

<p><span style='color:black'>这个实验的目的是学会配置和编译移植到</span><span lang=EN-US
style='font-family:"Simsun",serif;color:black'>ARM</span><span
style='color:black'>上的</span><span lang=EN-US style='font-family:"Simsun",serif;
color:black'>Linux</span><span style='color:black'>内核，深入理解</span><span
lang=EN-US style='font-family:"Simsun",serif;color:black'>Linux</span><span
style='color:black'>系统调用，比较</span><span lang=EN-US style='font-family:"Simsun",serif;
color:black'> ARM</span><span style='color:black'>和</span><span lang=EN-US
style='font-family:"Simsun",serif;color:black'>x86</span><span
style='color:black'>系统调用的不同。</span></p>

<h2><span style='font-size:16.0pt;color:black'>配合课程</span></h2>

<p><span style='color:black'>嵌入式</span><span lang=EN-US style='font-family:
"Simsun",serif;color:black'>Linux</span></p>

<h2><span style='font-size:16.0pt;color:black'>实验目的</span></h2>

<ol start=1 type=1>
 <li class=MsoNormal style='color:black;text-align:left'><span
     style='font-size:12.0pt;font-family:宋体'>学习</span><span lang=EN-US
     style='font-size:12.0pt;font-family:"Simsun",serif'>Linux</span><span
     style='font-size:12.0pt;font-family:宋体'>内核的配置和编译；</span></li>
 <li class=MsoNormal style='color:black;text-align:left'><span
     style='font-size:12.0pt;font-family:宋体'>深入理解</span><span lang=EN-US
     style='font-size:12.0pt;font-family:"Simsun",serif'>Linux</span><span
     style='font-size:12.0pt;font-family:宋体'>系统调用；</span></li>
 <li class=MsoNormal style='color:black;text-align:left'><span
     style='font-size:12.0pt;font-family:宋体'>理解</span><span lang=EN-US
     style='font-size:12.0pt;font-family:"Simsun",serif'>ARM</span><span
     style='font-size:12.0pt;font-family:宋体'>和</span><span lang=EN-US
     style='font-size:12.0pt;font-family:"Simsun",serif'>x86</span><span
     style='font-size:12.0pt;font-family:宋体'>的</span><span lang=EN-US
     style='font-size:12.0pt;font-family:"Simsun",serif'>CPU</span><span
     style='font-size:12.0pt;font-family:宋体'>模式（系统模式、用户模式等）的不同。</span></li>
 <li class=MsoNormal style='color:black;text-align:left'><span
     style='font-size:12.0pt;font-family:宋体'>掌握内核模块的编写方法。</span></li>
</ol>

<h2><span style='font-size:16.0pt;color:black'>实验器材</span></h2>

<h3><span style='font-size:14.0pt;line-height:173%;font-family:宋体;color:black'>硬件</span></h3>

<ul type=disc>
 <li class=MsoNormal style='color:black;text-align:left'><span lang=EN-US
     style='font-size:12.0pt;font-family:"Simsun",serif'>Linux</span><span
     style='font-size:12.0pt;font-family:宋体'>实验板卡（</span><span lang=EN-US
     style='font-size:12.0pt;font-family:"Simsun",serif'>Raspberry Pi 2</span><span
     style='font-size:12.0pt;font-family:宋体'>）一块；</span></li>
 <li class=MsoNormal style='color:black;text-align:left'><span lang=EN-US
     style='font-size:12.0pt;font-family:"Simsun",serif'>5V/1A</span><span
     style='font-size:12.0pt;font-family:宋体'>电源一个；</span></li>
 <li class=MsoNormal style='color:black;text-align:left'><span lang=EN-US
     style='font-size:12.0pt;font-family:"Simsun",serif'>microUSB</span><span
     style='font-size:12.0pt;font-family:宋体'>线一根；</span></li>
</ul>

<p><span style='color:black'>以下为自备（可选）器材：</span></p>

<ul type=disc>
 <li class=MsoNormal style='color:black;text-align:left'><span lang=EN-US
     style='font-size:12.0pt;font-family:"Simsun",serif'>PC</span><span
     style='font-size:12.0pt;font-family:宋体'>（</span><span lang=EN-US
     style='font-size:12.0pt;font-family:"Simsun",serif'>Windows/Mac OS/Linux</span><span
     style='font-size:12.0pt;font-family:宋体'>）一台；</span></li>
 <li class=MsoNormal style='color:black;text-align:left'><span lang=EN-US
     style='font-size:12.0pt;font-family:"Simsun",serif'>USB-TTL</span><span
     style='font-size:12.0pt;font-family:宋体'>串口线一根（</span><span lang=EN-US
     style='font-size:12.0pt;font-family:"Simsun",serif'>FT232RL</span><span
     style='font-size:12.0pt;font-family:宋体'>芯片或</span><span lang=EN-US
     style='font-size:12.0pt;font-family:"Simsun",serif'>PL2303</span><span
     style='font-size:12.0pt;font-family:宋体'>芯片）；</span></li>
 <li class=MsoNormal style='color:black;text-align:left'><span
     style='font-size:12.0pt;font-family:宋体'>以太网线一根（可能还需要路由器等）。</span></li>
</ul>

<h3><span style='font-size:14.0pt;line-height:173%;font-family:宋体;color:black'>软件</span></h3>

<ul type=disc>
 <li class=MsoNormal style='color:black;text-align:left'><span
     style='font-size:12.0pt;font-family:宋体'>交叉编译软件。</span></li>
</ul>

<h2><span style='font-size:16.0pt;color:black'>实验步骤</span></h2>

<p><span style='color:black'>使用交叉编译工具或本机编译工具，通过</span><span lang=EN-US
style='font-family:"Simsun",serif;color:black'>Linux</span><span
style='color:black'>内核源码进行实验</span><span lang=EN-US style='font-family:"Simsun",serif;
color:black'>:</span></p>

<p class=MsoNormal align=left style='margin-left:18.0pt;text-align:left;
text-indent:-18.0pt'><b><span lang=EN-US style='font-size:12.0pt;font-family:
"Simsun",serif;color:black'>1.<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span></b><b><span style='font-size:12.0pt;font-family:宋体;color:black'>寻找、下载</span></b><b><span
lang=EN-US style='font-size:12.0pt;font-family:"Simsun",serif;color:black'>Linux</span></b><b><span
style='font-size:12.0pt;font-family:宋体;color:black'>实验板卡所用的</span></b><b><span
lang=EN-US style='font-size:12.0pt;font-family:"Simsun",serif;color:black'>Linux</span></b><b><span
style='font-size:12.0pt;font-family:宋体;color:black'>内核源码；</span></b></p>

<p class=MsoNormal align=left style='text-align:left'><span style='font-size:
12.0pt;font-family:宋体;color:black'>本次实验从</span><span lang=EN-US
style='font-size:12.0pt;font-family:"Simsun",serif;color:black'>github</span><span
style='font-size:12.0pt;font-family:宋体;color:black'>上下载了</span><span
lang=EN-US style='font-size:12.0pt;font-family:"Simsun",serif;color:black'>linux-rpi-3.6.y</span><span
style='font-size:12.0pt;font-family:宋体;color:black'>源码。解压后文件夹大致内容如下：</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US><img
width=249 height=450 id="图片 1" src="em_Lab6.files/image001.jpg"><img width=266
height=450 id="图片 2" src="em_Lab6.files/image002.png"></span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US
style='font-size:12.0pt;font-family:"Simsun",serif;color:black'>&nbsp;</span></p>

<p class=MsoNormal align=left style='margin-left:18.0pt;text-align:left;
text-indent:-18.0pt'><b><span lang=EN-US style='font-size:12.0pt;font-family:
"Simsun",serif;color:black'>2.<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span></b><b><span style='font-size:12.0pt;font-family:宋体;color:black'>在内核中加入新的系统调用，具体功能没有要求，能输出调试信息即可</span></b><b><span
lang=EN-US style='font-size:12.0pt;font-family:"Simsun",serif;color:black'>;</span></b></p>

<p class=MsoNormal align=left style='text-align:left'><span style='font-size:
12.0pt;font-family:宋体;color:black'>首先在</span><span lang=EN-US style='font-size:
12.0pt;font-family:"Simsun",serif;color:black'>arch/arm/kernel</span><span
style='font-size:12.0pt;font-family:宋体;color:black'>中新建一个</span><span
lang=EN-US style='font-size:12.0pt;font-family:"Simsun",serif;color:black'>sys_mysyscall.c</span><span
style='font-size:12.0pt;font-family:宋体;color:black'>文件，编写系统调用函数实体，用于在后面输出内容来调试。</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US><img
width=264 height=108 id="图片 3" src="em_Lab6.files/image003.png"></span></p>

<p class=MsoNormal align=left style='text-align:left'><span style='font-size:
12.0pt;font-family:宋体;color:black'>同时，需要在</span><span lang=EN-US
style='font-size:12.0pt;font-family:"Simsun",serif;color:black'>makefile</span><span
style='font-size:12.0pt;font-family:宋体;color:black'>文件里面加上编译出的</span><span
lang=EN-US style='font-size:12.0pt;font-family:"Simsun",serif;color:black'>.o</span><span
style='font-size:12.0pt;font-family:宋体;color:black'>文件，用于之后的编译内核。</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US><img
width=527 height=181 id="图片 4" src="em_Lab6.files/image004.png"></span></p>

<p class=MsoNormal align=left style='text-align:left'><span style='font-size:
12.0pt;font-family:宋体;color:black'>之后需要修改中断向量表。即修改</span><span lang=EN-US
style='font-size:12.0pt;font-family:"Simsun",serif;color:black'>arch/arm/kernel/calls.S</span><span
style='font-size:12.0pt;font-family:宋体;color:black'>文件。参考以前做过的操作系统实验课程，</span><span
lang=EN-US style='font-size:12.0pt;font-family:"Simsun",serif;color:black'>223</span><span
style='font-size:12.0pt;font-family:宋体;color:black'>号调用没有被使用。于是考虑这次实验也修改</span><span
lang=EN-US style='font-size:12.0pt;font-family:"Simsun",serif;color:black'>223</span><span
style='font-size:12.0pt;font-family:宋体;color:black'>调用。修改为如下：</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US><img
width=482 height=106 id="图片 5" src="em_Lab6.files/image005.png"></span></p>

<p class=MsoNormal align=left style='text-align:left'><span style='font-size:
12.0pt;font-family:宋体;color:black'>之后在</span><span lang=EN-US style='font-size:
12.0pt;font-family:"Simsun",serif;color:black'>include/uapi/asm-generic/unistd.h</span><span
style='font-size:12.0pt;font-family:宋体;color:black'>头文件中把之前的系统调用与宏联系在一起：</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US><img
width=554 height=104 id="图片 6" src="em_Lab6.files/image006.jpg"></span></p>

<p class=MsoNormal align=left style='text-align:left'><span style='font-size:
12.0pt;font-family:宋体;color:black'>之后就可以编译了。</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US
style='font-size:12.0pt;font-family:"Simsun",serif;color:black'>&nbsp;</span></p>

<p class=MsoNormal align=left style='margin-left:18.0pt;text-align:left;
text-indent:-18.0pt'><b><span lang=EN-US style='font-size:12.0pt;font-family:
"Simsun",serif;color:black'>3.<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span></b><b><span style='font-size:12.0pt;font-family:宋体;color:black'>修改内核代码配置，编译内核；</span></b></p>

<p class=MsoNormal align=left style='text-align:left'><span style='font-size:
12.0pt;font-family:宋体;color:black'>修改</span><span lang=EN-US style='font-size:
12.0pt;font-family:"Simsun",serif;color:black'>config</span><span
style='font-size:12.0pt;font-family:宋体;color:black'>文件，使用现在树莓派上的</span><span
lang=EN-US style='font-size:12.0pt;font-family:"Simsun",serif;color:black'>config</span><span
style='font-size:12.0pt;font-family:宋体;color:black'>文件即可编译。可以使用</span><span
lang=EN-US style='font-size:12.0pt;font-family:"Simsun",serif;color:black'>zcat</span><span
style='font-size:12.0pt;font-family:宋体;color:black'>命令查看</span><span
lang=EN-US style='font-size:12.0pt;font-family:"Simsun",serif;color:black'>/proc/config.gz</span><span
style='font-size:12.0pt;font-family:宋体;color:black'>的内容。</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US><img
width=511 height=37 id="图片 7" src="em_Lab6.files/image007.png"></span></p>

<p class=MsoNormal align=left style='text-align:left'><span style='font-size:
12.0pt;font-family:宋体;color:black'>使用重定向修改了</span><span lang=EN-US
style='font-size:12.0pt;font-family:"Simsun",serif;color:black'>config</span><span
style='font-size:12.0pt;font-family:宋体;color:black'>文件。之后就可以进行编译了。</span></p>

<p class=MsoNormal><span style='font-size:12.0pt;font-family:宋体;color:black'>接着使用已有配制配制内核就可以了。</span></p>

<p class=MsoNormal><span lang=EN-US><img width=307 height=22 id="图片 8"
src="em_Lab6.files/image008.png"></span></p>

<p class=MsoNormal align=left style='text-align:left'><span style='font-size:
12.0pt;font-family:宋体;color:black'>之后如同之前的操作系统实验上的，使用</span><span lang=EN-US
style='font-size:12.0pt;font-family:"Simsun",serif;color:black'>make</span><span
style='font-size:12.0pt;font-family:宋体;color:black'>和</span><span lang=EN-US
style='font-size:12.0pt;font-family:"Simsun",serif;color:black'>make
module_install</span><span style='font-size:12.0pt;font-family:宋体;color:black'>：</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US><img
width=254 height=22 id="图片 9" src="em_Lab6.files/image009.png"></span></p>

<p class=MsoNormal align=left style='text-align:left'><span style='font-size:
12.0pt;font-family:宋体;color:black'>一开始选择现在</span><span lang=EN-US
style='font-size:12.0pt;font-family:"Simsun",serif;color:black'>PC</span><span
style='font-size:12.0pt;font-family:宋体;color:black'>上编译，发现编译出来还得放到树莓派上。后来嫌麻烦就直接在树莓派上编译了，虽然速度很慢。</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US
style='font-size:12.0pt;font-family:"Simsun",serif;color:black'>&nbsp;</span></p>

<p class=MsoNormal align=left style='margin-left:18.0pt;text-align:left;
text-indent:-18.0pt'><b><span lang=EN-US style='font-size:12.0pt;font-family:
"Simsun",serif;color:black'>4.<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span></b><b><span style='font-size:12.0pt;font-family:宋体;color:black'>将编译好的内核装载到板卡启动；</span></b></p>

<p class=MsoNormal align=left style='text-align:left'><span style='font-size:
12.0pt;font-family:宋体;color:black'>使用新的内核之前，需要备份更新一下内核和固件，当然还需要先备份一下。</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US><img
width=554 height=67 id="图片 10" src="em_Lab6.files/image010.jpg"></span></p>

<p class=MsoNormal align=left style='text-align:left'><span style='font-size:
12.0pt;font-family:宋体;color:black'>然后更新固件和内核：</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US><img
width=554 height=101 id="图片 12" src="em_Lab6.files/image011.jpg"></span></p>

<p class=MsoNormal align=left style='text-align:left'><span style='font-size:
12.0pt;font-family:宋体;color:black'>之后就可以</span><span lang=EN-US
style='font-size:12.0pt;font-family:"Simsun",serif;color:black'>reboot</span><span
style='font-size:12.0pt;font-family:宋体;color:black'>重启进入新的内核了。</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US
style='font-size:12.0pt;font-family:"Simsun",serif;color:black'>&nbsp;</span></p>

<p class=MsoNormal align=left style='margin-left:18.0pt;text-align:left;
text-indent:-18.0pt'><b><span lang=EN-US style='font-size:12.0pt;font-family:
"Simsun",serif;color:black'>5.<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span></b><b><span style='font-size:12.0pt;font-family:宋体;color:black'>编写</span></b><b><span
lang=EN-US style='font-size:12.0pt;font-family:"Simsun",serif;color:black'>C</span></b><b><span
style='font-size:12.0pt;font-family:宋体;color:black'>代码，用两种方法做系统调用，测试：</span></b></p>

<p class=MsoNormal align=left style='margin-left:54.0pt;text-align:left;
text-indent:-18.0pt'><b><span lang=EN-US style='font-size:12.0pt;font-family:
"Simsun",serif;color:black'>a.<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span></b><b><span style='font-size:12.0pt;font-family:宋体;color:black'>嵌入汇编代码，用</span></b><b><span
lang=EN-US style='font-size:12.0pt;font-family:"Simsun",serif;color:black'>r0</span></b><b><span
style='font-size:12.0pt;font-family:宋体;color:black'>传参数；</span></b></p>

<p class=MsoNormal align=left style='margin-left:54.0pt;text-align:left;
text-indent:-18.0pt'><b><span lang=EN-US style='font-size:12.0pt;font-family:
"Simsun",serif;color:black'>b.<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span></b><b><span style='font-size:12.0pt;font-family:宋体;color:black'>用</span></b><b><span
lang=EN-US style='font-size:12.0pt;font-family:"Simsun",serif;color:black'>syscall()</span></b><b><span
style='font-size:12.0pt;font-family:宋体;color:black'>函数。</span></b></p>

<p class=MsoNormal align=left style='text-align:left'><span style='font-size:
12.0pt;font-family:宋体;color:black'>使用系统调用函数</span><span lang=EN-US
style='font-size:12.0pt;font-family:"Simsun",serif;color:black'>syscall()</span><span
style='font-size:12.0pt;font-family:宋体;color:black'>的方法如下：</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US><img
width=241 height=125 id="图片 19" src="em_Lab6.files/image012.png"></span></p>

<p class=MsoNormal align=left style='text-align:left'><span style='font-size:
12.0pt;font-family:宋体;color:black'>嵌入式汇编代码如下：</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US><img
width=382 height=208 id="图片 13" src="em_Lab6.files/image013.png"></span></p>

<p class=MsoNormal align=left style='text-align:left'><span style='font-size:
12.0pt;font-family:宋体;color:black'>汇编函数首先保存之前的寄存器值，之后写入</span><span lang=EN-US
style='font-size:12.0pt;font-family:"Simsun",serif;color:black'>r0</span><span
style='font-size:12.0pt;font-family:宋体;color:black'>寄存器为</span><span
lang=EN-US style='font-size:12.0pt;font-family:"Simsun",serif;color:black'>223</span><span
style='font-size:12.0pt;font-family:宋体;color:black'>，之后使用</span><span
lang=EN-US style='font-size:12.0pt;font-family:"Simsun",serif;color:black'>bl</span><span
style='font-size:12.0pt;font-family:宋体;color:black'>调用</span><span lang=EN-US
style='font-size:12.0pt;font-family:"Simsun",serif;color:black'>syscall</span><span
style='font-size:12.0pt;font-family:宋体;color:black'>，最后重回现场即可。</span></p>

<p class=MsoNormal align=left style='text-align:left'><span style='font-size:
12.0pt;font-family:宋体;color:black'>上述两者方法都可以正确进行。运行编译结果</span><span lang=EN-US
style='font-size:12.0pt;font-family:"Simsun",serif;color:black'>./a.out</span><span
style='font-size:12.0pt;font-family:宋体;color:black'>，可以看到输出内容，使用</span><span
lang=EN-US style='font-size:12.0pt;font-family:"Simsun",serif;color:black'>dmesg
| tail</span><span style='font-size:12.0pt;font-family:宋体;color:black'>命令查看：</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US><img
width=411 height=167 id="图片 17" src="em_Lab6.files/image014.png"></span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US><img
width=417 height=150 id="图片 18" src="em_Lab6.files/image015.png"></span></p>

<p class=MsoNormal align=left style='text-align:left'><span style='font-size:
12.0pt;font-family:宋体;color:black'>可以看到都正确输出了结果。</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US
style='font-size:12.0pt;font-family:"Simsun",serif;color:black'>&nbsp;</span></p>

<p class=MsoNormal align=left style='margin-left:18.0pt;text-align:left;
text-indent:-18.0pt'><b><span lang=EN-US style='font-size:12.0pt;font-family:
"Simsun",serif;color:black'>6.<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span></b><b><span style='font-size:12.0pt;font-family:宋体;color:black'>编写内核模块，在模块加载和卸载时能通过内核打印函数输出提示信息；</span></b></p>

<p class=MsoNormal align=left style='text-align:left'><span style='font-size:
12.0pt;font-family:宋体;color:black'>编写内核模块，可以参考以前的操作糸统的实验：</span></p>

<table class=MsoTableGrid border=0 cellspacing=0 cellpadding=0
 style='background:#E7E6E6;border-collapse:collapse;border:none'>
 <tr>
  <td width=553 valign=top style='width:414.8pt;padding:0cm 5.4pt 0cm 5.4pt'>
  <p class=MsoNormal align=left style='text-align:left'><span lang=EN-US
  style='font-size:12.0pt;font-family:"Simsun",serif;color:black'>#include
  &lt;linux/init.h&gt;</span></p>
  </td>
 </tr>
 <tr>
  <td width=553 valign=top style='width:414.8pt;padding:0cm 5.4pt 0cm 5.4pt'>
  <p class=MsoNormal align=left style='text-align:left'><span lang=EN-US
  style='font-size:12.0pt;font-family:"Simsun",serif;color:black'>#include
  &lt;linux/kernel.h&gt;</span></p>
  </td>
 </tr>
 <tr>
  <td width=553 valign=top style='width:414.8pt;padding:0cm 5.4pt 0cm 5.4pt'>
  <p class=MsoNormal align=left style='text-align:left'><span lang=EN-US
  style='font-size:12.0pt;font-family:"Simsun",serif;color:black'>#include
  &lt;linux/module.h&gt;</span></p>
  </td>
 </tr>
 <tr>
  <td width=553 valign=top style='width:414.8pt;padding:0cm 5.4pt 0cm 5.4pt'>
  <p class=MsoNormal align=left style='text-align:left'><span lang=EN-US
  style='font-size:12.0pt;font-family:"Simsun",serif;color:black'>MODULE_LICENSE(&quot;GPL&quot;);</span></p>
  </td>
 </tr>
 <tr>
  <td width=553 valign=top style='width:414.8pt;padding:0cm 5.4pt 0cm 5.4pt'>
  <p class=MsoNormal align=left style='text-align:left'><span lang=EN-US
  style='font-size:12.0pt;font-family:"Simsun",serif;color:black'>tatic int
  __init reverse_init(void)</span></p>
  </td>
 </tr>
 <tr>
  <td width=553 valign=top style='width:414.8pt;padding:0cm 5.4pt 0cm 5.4pt'>
  <p class=MsoNormal align=left style='text-align:left'><span lang=EN-US
  style='font-size:12.0pt;font-family:"Simsun",serif;color:black'>{</span></p>
  </td>
 </tr>
 <tr>
  <td width=553 valign=top style='width:414.8pt;padding:0cm 5.4pt 0cm 5.4pt'>
  <p class=MsoNormal align=left style='text-align:left'><span lang=EN-US
  style='font-size:12.0pt;font-family:"Simsun",serif;color:black'>&nbsp;&nbsp;&nbsp;
  printk(KERN_INFO &quot;Hi!\n&quot;);</span></p>
  </td>
 </tr>
 <tr>
  <td width=553 valign=top style='width:414.8pt;padding:0cm 5.4pt 0cm 5.4pt'>
  <p class=MsoNormal align=left style='text-align:left'><span lang=EN-US
  style='font-size:12.0pt;font-family:"Simsun",serif;color:black'>&nbsp;&nbsp;&nbsp;
  return 0;</span></p>
  </td>
 </tr>
 <tr>
  <td width=553 valign=top style='width:414.8pt;padding:0cm 5.4pt 0cm 5.4pt'>
  <p class=MsoNormal align=left style='text-align:left'><span lang=EN-US
  style='font-size:12.0pt;font-family:"Simsun",serif;color:black'>}</span></p>
  </td>
 </tr>
 <tr>
  <td width=553 valign=top style='width:414.8pt;padding:0cm 5.4pt 0cm 5.4pt'>
  <p class=MsoNormal align=left style='text-align:left'><span lang=EN-US
  style='font-size:12.0pt;font-family:"Simsun",serif;color:black'>static void
  __exit reverse_exit(void)</span></p>
  </td>
 </tr>
 <tr>
  <td width=553 valign=top style='width:414.8pt;padding:0cm 5.4pt 0cm 5.4pt'>
  <p class=MsoNormal align=left style='text-align:left'><span lang=EN-US
  style='font-size:12.0pt;font-family:"Simsun",serif;color:black'>{</span></p>
  </td>
 </tr>
 <tr>
  <td width=553 valign=top style='width:414.8pt;padding:0cm 5.4pt 0cm 5.4pt'>
  <p class=MsoNormal align=left style='text-align:left'><span lang=EN-US
  style='font-size:12.0pt;font-family:"Simsun",serif;color:black'>&nbsp;&nbsp;&nbsp;
  printk(KERN_INFO &quot;Bye!\n&quot;);</span></p>
  </td>
 </tr>
 <tr>
  <td width=553 valign=top style='width:414.8pt;padding:0cm 5.4pt 0cm 5.4pt'>
  <p class=MsoNormal align=left style='text-align:left'><span lang=EN-US
  style='font-size:12.0pt;font-family:"Simsun",serif;color:black'>}</span></p>
  </td>
 </tr>
 <tr>
  <td width=553 valign=top style='width:414.8pt;padding:0cm 5.4pt 0cm 5.4pt'>
  <p class=MsoNormal align=left style='text-align:left'><span lang=EN-US
  style='font-size:12.0pt;font-family:"Simsun",serif;color:black'>module_init(reverse_init);</span></p>
  </td>
 </tr>
 <tr>
  <td width=553 valign=top style='width:414.8pt;padding:0cm 5.4pt 0cm 5.4pt'>
  <p class=MsoNormal align=left style='text-align:left'><span lang=EN-US
  style='font-size:12.0pt;font-family:"Simsun",serif;color:black'>module_exit(reverse_exit);</span></p>
  </td>
 </tr>
</table>

<p class=MsoNormal align=left style='text-align:left'><span style='font-size:
12.0pt;font-family:宋体;color:black'>该模块可以在装载时输出“</span><span lang=EN-US
style='font-size:12.0pt;font-family:"Simsun",serif;color:black'>Hi!</span><span
style='font-size:12.0pt;font-family:宋体;color:black'>”，在卸载时可以输出“</span><span
lang=EN-US style='font-size:12.0pt;font-family:"Simsun",serif;color:black'>Bye!</span><span
style='font-size:12.0pt;font-family:宋体;color:black'>”。由于直接在树莓派上编译出现了问题，最后选择在</span><span
lang=EN-US style='font-size:12.0pt;font-family:"Simsun",serif;color:black'>PC</span><span
style='font-size:12.0pt;font-family:宋体;color:black'>上使用交叉编译的方法，编译出</span><span
lang=EN-US style='font-size:12.0pt;font-family:"Simsun",serif;color:black'>.ko</span><span
style='font-size:12.0pt;font-family:宋体;color:black'>文件，然后拷贝到树莓派上使用</span><span
lang=EN-US style='font-size:12.0pt;font-family:"Simsun",serif;color:black'>insmod</span><span
style='font-size:12.0pt;font-family:宋体;color:black'>和</span><span lang=EN-US
style='font-size:12.0pt;font-family:"Simsun",serif;color:black'>lsmod</span><span
style='font-size:12.0pt;font-family:宋体;color:black'>测试即可。因此需要在</span><span
lang=EN-US style='font-size:12.0pt;font-family:"Simsun",serif;color:black'>PC</span><span
style='font-size:12.0pt;font-family:宋体;color:black'>上重新编写</span><span
lang=EN-US style='font-size:12.0pt;font-family:"Simsun",serif;color:black'>makefile</span><span
style='font-size:12.0pt;font-family:宋体;color:black'>：</span></p>

<table class=MsoTableGrid border=0 cellspacing=0 cellpadding=0
 style='background:#E7E6E6;border-collapse:collapse;border:none'>
 <tr>
  <td width=553 valign=top style='width:414.8pt;padding:0cm 5.4pt 0cm 5.4pt'>
  <p class=MsoNormal align=left style='text-align:left'><span lang=EN-US
  style='font-size:12.0pt;font-family:"Simsun",serif;color:black'>obj-m := mykernel.o</span></p>
  </td>
 </tr>
 <tr>
  <td width=553 valign=top style='width:414.8pt;padding:0cm 5.4pt 0cm 5.4pt'>
  <p class=MsoNormal align=left style='text-align:left'><span lang=EN-US
  style='font-size:12.0pt;font-family:"Simsun",serif;color:black'>KERNEL_VER :=
  3.6.y</span></p>
  </td>
 </tr>
 <tr>
  <td width=553 valign=top style='width:414.8pt;padding:0cm 5.4pt 0cm 5.4pt'>
  <p class=MsoNormal align=left style='text-align:left'><span lang=EN-US
  style='font-size:12.0pt;font-family:"Simsun",serif;color:black'>KERNEL_DIR :=
  /media/turtle/g1t15346-h4h8-4h64-4g56-45269hfbne1/lib/modules/$(KERNEL_VER)/build</span></p>
  </td>
 </tr>
 <tr>
  <td width=553 valign=top style='width:414.8pt;padding:0cm 5.4pt 0cm 5.4pt'>
  <p class=MsoNormal align=left style='text-align:left'><span lang=EN-US
  style='font-size:12.0pt;font-family:"Simsun",serif;color:black'>PWD :=
  $(shell pwd)</span></p>
  </td>
 </tr>
 <tr>
  <td width=553 valign=top style='width:414.8pt;padding:0cm 5.4pt 0cm 5.4pt'>
  <p class=MsoNormal align=left style='text-align:left'><span lang=EN-US
  style='font-size:12.0pt;font-family:"Simsun",serif;color:black'>ARGS :=
  ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf-</span></p>
  </td>
 </tr>
 <tr>
  <td width=553 valign=top style='width:414.8pt;padding:0cm 5.4pt 0cm 5.4pt'>
  <p class=MsoNormal align=left style='text-align:left'><span lang=EN-US
  style='font-size:12.0pt;font-family:"Simsun",serif;color:black'>all:</span></p>
  </td>
 </tr>
 <tr>
  <td width=553 valign=top style='width:414.8pt;padding:0cm 5.4pt 0cm 5.4pt'>
  <p class=MsoNormal align=left style='text-align:left'><span lang=EN-US
  style='font-size:12.0pt;font-family:"Simsun",serif;color:black'>&nbsp;&nbsp;&nbsp;
  make -C $(KERNEL_DIR) SUBDIRS=$(PWD) $(ARGS) modules</span></p>
  </td>
 </tr>
 <tr>
  <td width=553 valign=top style='width:414.8pt;padding:0cm 5.4pt 0cm 5.4pt'>
  <p class=MsoNormal align=left style='text-align:left'><span lang=EN-US
  style='font-size:12.0pt;font-family:"Simsun",serif;color:black'>clean:</span></p>
  </td>
 </tr>
 <tr>
  <td width=553 valign=top style='width:414.8pt;padding:0cm 5.4pt 0cm 5.4pt'>
  <p class=MsoNormal align=left style='text-align:left'><span lang=EN-US
  style='font-size:12.0pt;font-family:"Simsun",serif;color:black'>&nbsp;&nbsp;&nbsp;
  rm *.o *.ko *.mod.c</span></p>
  </td>
 </tr>
 <tr>
  <td width=553 valign=top style='width:414.8pt;padding:0cm 5.4pt 0cm 5.4pt'>
  <p class=MsoNormal align=left style='text-align:left'><span lang=EN-US
  style='font-size:12.0pt;font-family:"Simsun",serif;color:black'>.PHONY:clean</span></p>
  </td>
 </tr>
</table>

<p class=MsoNormal align=left style='text-align:left'><span style='font-size:
12.0pt;font-family:宋体;color:black'>之后使用</span><span lang=EN-US
style='font-size:12.0pt;font-family:"Simsun",serif;color:black'>make</span><span
style='font-size:12.0pt;font-family:宋体;color:black'>编译出</span><span lang=EN-US
style='font-size:12.0pt;font-family:"Simsun",serif;color:black'>ko</span><span
style='font-size:12.0pt;font-family:宋体;color:black'>文件拷贝到树莓派上即可。</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US
style='font-size:12.0pt;font-family:"Simsun",serif;color:black'>&nbsp;</span></p>

<p class=MsoNormal align=left style='margin-left:18.0pt;text-align:left;
text-indent:-18.0pt'><b><span lang=EN-US style='font-size:12.0pt;font-family:
"Simsun",serif;color:black'>7.<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span></b><b><span style='font-size:12.0pt;font-family:宋体;color:black'>通过</span></b><b><span
lang=EN-US style='font-size:12.0pt;font-family:"Simsun",serif;color:black'>insmod</span></b><b><span
style='font-size:12.0pt;font-family:宋体;color:black'>和</span></b><b><span
lang=EN-US style='font-size:12.0pt;font-family:"Simsun",serif;color:black'>lsmod</span></b><b><span
style='font-size:12.0pt;font-family:宋体;color:black'>等命令测试内核模块。</span></b></p>

<p class=MsoNormal align=left style='text-align:left'><span style='font-size:
12.0pt;font-family:宋体;color:black'>使用</span><span lang=EN-US style='font-size:
12.0pt;font-family:"Simsun",serif;color:black'>insmod</span><span
style='font-size:12.0pt;font-family:宋体;color:black'>和</span><span lang=EN-US
style='font-size:12.0pt;font-family:"Simsun",serif;color:black'>lsmod</span><span
style='font-size:12.0pt;font-family:宋体;color:black'>来测试模块是否安装成功：</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US><img
width=554 height=313 id="图片 14" src="em_Lab6.files/image016.png"></span></p>

<p class=MsoNormal align=left style='text-align:left'><span style='font-size:
12.0pt;font-family:宋体;color:black'>然后可以在日志里查看安装模块时是否有输出（使用</span><span
lang=EN-US style='font-size:12.0pt;font-family:"Simsun",serif;color:black'>dmesg
| tail</span><span style='font-size:12.0pt;font-family:宋体;color:black'>命令）：</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US><img
width=483 height=405 id="图片 16" src="em_Lab6.files/image017.png"></span></p>

<p class=MsoNormal align=left style='text-align:left'><span style='font-size:
12.0pt;font-family:宋体;color:black'>可以看到使用</span><span lang=EN-US
style='font-size:12.0pt;font-family:"Simsun",serif;color:black'>insmod</span><span
style='font-size:12.0pt;font-family:宋体;color:black'>和</span><span lang=EN-US
style='font-size:12.0pt;font-family:"Simsun",serif;color:black'>rmmod</span><span
style='font-size:12.0pt;font-family:宋体;color:black'>之后正确在日志里输出了正确结果。</span></p>

</div>

</body>

</html>
